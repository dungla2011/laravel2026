
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vẽ Gia Phả</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        svg {
            border: 1px solid #ccc;
            display: block;
            margin: auto;
        }
    </style>
</head>
<body>
<svg id="familyTreeSvg" width="1200" height="800"></svg>
<script>


    function sortFamilyTree(data) {
        // Tạo map để tra cứu nhanh theo id
        const idMap = new Map(data.map(item => [item.id, item]));

        // Tạo map để lưu danh sách người phối ngẫu theo id
        const spousesMap = new Map();

        // Xây dựng map các cặp vợ chồng
        data.forEach(person => {
            if (person.married_with) {
                // Thêm người phối ngẫu vào danh sách
                if (!spousesMap.has(person.married_with)) {
                    spousesMap.set(person.married_with, []);
                }
                spousesMap.get(person.married_with).push(person.id);

                // Thêm người hiện tại vào danh sách phối ngẫu của người kia
                if (!spousesMap.has(person.id)) {
                    spousesMap.set(person.id, []);
                }
                spousesMap.get(person.id).push(person.married_with);
            }
        });

        // Tạo mảng kết quả mới
        const result = [];
        const added = new Set();

        // Hàm thêm người và các phối ngẫu vào kết quả
        function addPersonAndSpouses(personId) {
            if (added.has(personId)) return;

            // Thêm người hiện tại
            const person = idMap.get(personId);
            result.push(person);
            added.add(personId);

            // Thêm các phối ngẫu
            const spouses = spousesMap.get(personId) || [];
            spouses.forEach(spouseId => {
                if (!added.has(spouseId)) {
                    const spouse = idMap.get(spouseId);
                    result.push(spouse);
                    added.add(spouseId);
                }
            });
        }

        // Duyệt qua từng người trong dữ liệu gốc
        data.forEach(person => {
            addPersonAndSpouses(person.id);
        });

        return result;
    }


    const rootId = 0;
    let data = [
        { "id": 321525, "parent_id": rootId, "name": "A0", "married_with": null, "gender": 1 },
        { "id": 321543, "parent_id": rootId, "name": "B0", "married_with": 321525, "gender": 1 },
        { "id": 321526, "parent_id": 321525, "name": "A1", "married_with": null, "gender": 1 },
        { "id": 321531, "parent_id": 321525, "name": "A2", "married_with": null, "gender": 1 },
        { "id": 321532, "parent_id": 321525, "name": "B1", "married_with": 321526, "gender": 2 },
        { "id": 321535, "parent_id": 321525, "name": "A3", "married_with": null, "gender": 2 },
        { "id": 321536, "parent_id": 321525, "name": "A4", "married_with": null, "gender": 1 },
        { "id": 321541, "parent_id": 321525, "name": "B3", "married_with": 321535, "gender": 1 },
        { "id": 321544, "parent_id": 321525, "name": "C3", "married_with": 321535, "gender": 1 },
        { "id": 321527, "parent_id": 321526, "name": "A11", "married_with": null, "gender": 1 },
        { "id": 321528, "parent_id": 321526, "name": "A12", "married_with": null, "gender": 1 },
        { "id": 321530, "parent_id": 321526, "name": "A13", "married_with": null, "gender": 1 },
        { "id": 321537, "parent_id": 321535, "name": "A31", "married_with": null, "gender": 1 },
        { "id": 321538, "parent_id": 321535, "name": "A32", "married_with": null, "gender": 1 },
        { "id": 321542, "parent_id": 321528, "name": "A121", "married_with": null, "gender": 1 },
        { "id": rootId, "parent_id": null, "married_with": null, "gender": 1, "name": "Root" } ];

    let data0 = JSON.parse(JSON.stringify(data));
    // Test hàm với dữ liệu
    data = sortFamilyTree(data);
    // console.log(data0, sortedData);

    console.log("Data = ", data);



    // Tham số cấu hình
    const nodeWidth = 50;
    const nodeHeight = 40;
    const horizontalSpacing = 20;
    const verticalSpacing = 50;

    // Tạo cấu trúc cây từ danh sách
    function buildTree(data, rootId) {
        const idToNode = {};
        data.forEach(node => {
            idToNode[node.id] = { ...node, children: [] };
        });

        data.forEach(node => {
            if (idToNode[node.parent_id]) {
                idToNode[node.parent_id].children.push(idToNode[node.id]);
            }
        });

        return idToNode[rootId] || null;
    }
    function centerTree(svgElement, treeData) {
        // Lấy kích thước của SVG container
        const svgWidth = svgElement.node().getBoundingClientRect().width;

        // Tính toán bounds của cây
        let minX = Infinity;
        let maxX = -Infinity;
        let minY = Infinity;
        let maxY = -Infinity;

        treeData.descendants().forEach(d => {
            minX = Math.min(minX, d.x);
            maxX = Math.max(maxX, d.x);
            minY = Math.min(minY, d.y);
            maxY = Math.max(maxY, d.y);
        });

        // Tính toán độ rộng và cao của cây
        const treeWidth = maxX - minX;

        // Tính toán offset để căn giữa
        const xOffset = (svgWidth - treeWidth) / 2 - minX;
        const yOffset = 100 - minY; // Đặt root cách top 100px

        // Cập nhật vị trí của tất cả các node và đường nối
        const svgGroup = svgElement.select("g");

        // Cập nhật vị trí các node
        svgGroup.selectAll(".node")
            .attr("transform", d => `translate(${d.x + xOffset},${d.y + yOffset})`);

        // Cập nhật vị trí các đường nối
        svgGroup.selectAll(".link")
            .attr("x1", d => d.source.x + xOffset)
            .attr("y1", d => d.source.y + yOffset)
            .attr("x2", d => d.target.x + xOffset)
            .attr("y2", d => d.target.y + yOffset);

        return svgGroup;
    }
    const root = buildTree(data, rootId);

    // Chuyển đổi dữ liệu sang định dạng D3 tree
    const treeData = d3.hierarchy(root, d => d.children);
    const treeLayout = d3.tree().nodeSize([nodeWidth + horizontalSpacing, nodeHeight + verticalSpacing]);
    treeLayout(treeData);

    const svg = d3.select("#familyTreeSvg")
        .call(d3.zoom().on("zoom", (event) => {
            svgGroup.attr("transform", event.transform);
        }));

    const svgGroup = svg.append("g");

    // Vẽ các đường nối
    svgGroup.selectAll(".link")
        .data(treeData.links())
        .enter()
        .append("line")
        .attr("class", "link")
        .attr("x1", d => d.source.x + 200)
        .attr("y1", d => d.source.y + 50)
        .attr("x2", d => d.target.x + 200)
        .attr("y2", d => d.target.y + 50)
        .attr("stroke", "#ccc");

    // Vẽ các node
    const nodes = svgGroup.selectAll(".node")
        .data(treeData.descendants())
        .enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.x + 200},${d.y + 50})`);

    nodes.append("rect")
        .attr("width", nodeWidth)
        .attr("height", nodeHeight)
        .attr("x", -nodeWidth / 2)
        .attr("y", -nodeHeight / 2)
        .attr("fill", "#fff")
        .attr("stroke", "#000");

    nodes.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", "5")
        .text(d => d.data.name);

    centerTree(svg, treeData);

</script>
</body>
</html>
