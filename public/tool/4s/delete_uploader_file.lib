<?php

/*
 * Update 02.2025
 * Review OK: 10.3.2015
 */

$_SERVER['HTTP_HOST'] = $_SERVER['SERVER_NAME'] = "4share.vn";


require '/var/www/html/vendor/autoload.php';
$app = require_once '/var/www/html/bootstrap/app.php';
$kernel = $app->make(Illuminate\Contracts\Http\Kernel::class);
$response = $kernel->handle(
    $request = Illuminate\Http\Request::capture()
);


if (!isCli()) {
    echo "ERROR: NOT CLI!";
    return;
}


function outputLog($str)
{
    global $date, $nolog, $allowDelete;
    $padReal = "";
    if ($allowDelete)
        $padReal = "_real_delete";
    if (!file_exists("/var/glx/weblog/delete_uploader_file/"))
        mkdir("/var/glx/weblog/delete_uploader_file/");
    if ($nolog == 0)
        outputT("/var/glx/weblog/delete_uploader_file/$date$padReal.log", $str);
    echo("\n$str");
}

function outputError($str)
{
    global $date;
    if (!file_exists("/var/glx/weblog/delete_user_data/"))
        mkdir("/var/glx/weblog/delete_user_data/");
    outputT("/var/glx/weblog/delete_user_data/$date.error.log", $str);
    echo("\n$str");
}

function ol1($str)
{
    outputLog($str);
}


//$mm = \App\Models\FileUpload::where("user_id", 1573860)->where("created_at", "<=", "2024-12-01")->where(
//    function ($query) {
//            $query->where("count_download", '<=', 1);
//        })->get();

//$mm = \App\Models\FileUpload::where("user_id", 1573860)->where("lastdate_down", "<=", "2024-12-01")->where("count_download", '<=', 1)->get();

//$mm = \App\Models\FileUpload::where("lastdate_down", "<=", "2024-12-01")->where("count_download", '<=', 1)->get();

//$mm = \App\Models\FileUpload::where("user_id", 1573860)->where(function ($query) {
//    $query->where("lastdate_down", "<=", "2024-12-01")->orWhere("lastdate_down", null);
//})->where("count_download", '<=', 1)->get();

$tmp = \App\Models\UploaderInfo::all();
$mUploader = $tmp->pluck('user_id')->toArray();

// Lay ra UID va email tuong ung tu mang UserId
$mUserEmails = \App\Models\User::whereIn('id', $mUploader)
    ->get(['id', 'email'])
    ->pluck('email', 'id')
    ->toArray();

echo "\n Uploader Email: ";
echo "<pre>";
print_r($mUserEmails);
echo "</pre>";

$mUidIgnore = [1, 3,4, 1653142, 553871, 1556067, 6624, 1639981, 1568168];

$mUserEmailIgnore = \App\Models\User::whereIn('id', $mUidIgnore)
    ->get(['id', 'email'])
    ->pluck('email', 'id')
    ->toArray();
echo "<pre>";
echo "\n Ignore: ";
print_r($mUserEmailIgnore);
echo "</pre>";

if(!isCli()){
    die();
}


$optNgayTao = date("Y-m-d", time() - 4 * 30 * 24 * 3600);
$optNgayTaiCuoi = date("Y-m-d", time() - 4 * 30 * 24 * 3600);
$optSoLanTai = 1;

//Neu argv 1 có chứa delete
$allowDelete = 0;
if (isset($argv[1]) && strpos($argv[1], "delete") !== false) {
    $allowDelete = 1;
    echo "\n Allow Delete!";
}


getch("....");

echo "\n Check now ... wait about 30 seconds ...";

//return;
$limitSize = 100 * _MB;
$mm = \App\Models\FileUpload::where("user_id",'>', 0)->where("created_at", "<=", "$optNgayTao 00:00:00")
    ->where('file_size', '>', $limitSize)
    ->where(function ($query) use ($optNgayTaiCuoi, $optSoLanTai){
    $query->where("lastdate_down", "<=", "$optNgayTaiCuoi 00:00:00")->orWhere("lastdate_down", null);
})->where("count_download", '<=', $optSoLanTai)->get();


//
$tt = count($mm);

echo "\n TT = $tt";

//return;
$cc = 0;
$tsize = 0;
$nDel = 0;
foreach ($mm AS $file){
    $cc++;
    $bs = ByteSize($tsize);
    $uid = $file->user_id;

    echo "\n $cc / $tt. FID: $file->id, $file->created_at, UID: $file->user_id, $file->name";
    if(!in_array($uid, $mUploader))
        continue;
    if(in_array($uid, $mUidIgnore)){
        continue;
    }
    $nDel++;

    if($allowDelete){
        $file->delete_by = 2;
        $file->addLog("DELETE_UPLOADER_FILE optNgayTao=$optNgayTao, optNgayTaiCuoi = $optNgayTaiCuoi, optSoLanTai = $optSoLanTai");
        $file->save();
        $file->delete();
    }

    echo "\n BS = $bs ($nDel)";
    echo "\n";

    $tsize+=$file->file_size;

    if($tsize > 10000 * _GB) {
        echo "\n Stop because size > 10TB";
        die();
    }
}
